# Q-Q Plot (Quantile-Quantile Plot) 완벽 가이드

## 📌 개요

### Q-Q Plot이란?
**Q-Q Plot (분위수-분위수 그림)**은 데이터가 특정 이론적 분포(주로 정규분포)를 따르는지 **시각적으로 검증**하는 그래프

| 항목 | 내용 |
|---|---|
| **목적** | 데이터의 분포 형태 확인 (정규성 검정) |
| **X축** | 이론적 분위수 (Theoretical Quantiles) |
| **Y축** | 표본 분위수 (Sample Quantiles) |
| **해석** | 점들이 직선에 가까우면 해당 분포를 따름 |

---

## 1️⃣ Q-Q Plot을 사용하는 이유

### 1.1 왜 정규성 검정이 필요한가?

많은 통계 분석 기법들이 **정규분포 가정**을 전제로 함:

| 분석 기법 | 정규성 가정 |
|---|---|
| t-검정 | 모집단이 정규분포 |
| ANOVA | 각 그룹이 정규분포 |
| 선형회귀 | 잔차가 정규분포 |
| 상관분석 | 변수들이 정규분포 |

### 1.2 Q-Q Plot의 장점

| 방법 | 장점 | 단점 |
|---|---|---|
| **Q-Q Plot** | 분포의 어느 부분이 벗어나는지 시각적 확인 가능 | 주관적 판단 |
| Shapiro-Wilk 검정 | 객관적 p-value 제공 | 표본 크기에 민감 |
| Kolmogorov-Smirnov 검정 | 대표본에 적합 | 꼬리 부분 민감도 낮음 |

→ **Q-Q Plot + 통계 검정**을 함께 사용하는 것이 가장 좋음

---

## 2️⃣ Q-Q Plot의 원리

### 2.1 핵심 아이디어

```
만약 데이터가 정규분포를 따른다면,
데이터의 분위수와 정규분포의 분위수가 일치해야 한다!
```

### 2.2 분위수(Quantile)란?

데이터를 크기 순으로 정렬했을 때, 특정 비율 이하에 해당하는 값

| 분위수 | 의미 | 예시 (1~100 데이터) |
|---|---|---|
| 0.25 (Q1) | 하위 25% 지점 | 25 |
| 0.50 (Q2) | 하위 50% 지점 (중앙값) | 50 |
| 0.75 (Q3) | 하위 75% 지점 | 75 |

### 2.3 Q-Q Plot 구성 원리

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│   표본 데이터         이론적 분포 (정규분포)              │
│   ┌─────────┐         ┌─────────┐                       │
│   │ x₁      │         │ z₁      │                       │
│   │ x₂      │   vs    │ z₂      │                       │
│   │ ...     │         │ ...     │                       │
│   │ xₙ      │         │ zₙ      │                       │
│   └─────────┘         └─────────┘                       │
│                                                         │
│   각 순서에 해당하는 값들을 (이론값, 표본값)으로 그림      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 3️⃣ 수치 예제로 이해하기

### 3.1 예제 데이터

10명의 학생 시험 점수:

```
원본 데이터: 72, 85, 91, 68, 77, 83, 89, 74, 80, 86
```

### 3.2 Step 1: 데이터 정렬 (오름차순)

| 순위 (i) | 정렬된 데이터 (xᵢ) |
|:---:|:---:|
| 1 | 68 |
| 2 | 72 |
| 3 | 74 |
| 4 | 77 |
| 5 | 80 |
| 6 | 83 |
| 7 | 85 |
| 8 | 86 |
| 9 | 89 |
| 10 | 91 |

### 3.3 Step 2: 표본 분위수 위치 계산

**분위수 위치 공식** (여러 방법 중 일반적인 방식):

$$p_i = \frac{i - 0.5}{n}$$

- $i$: 순위 (1, 2, ..., n)
- $n$: 표본 크기

| 순위 (i) | 분위수 위치 (pᵢ) | 계산 |
|:---:|:---:|:---:|
| 1 | 0.05 | (1-0.5)/10 |
| 2 | 0.15 | (2-0.5)/10 |
| 3 | 0.25 | (3-0.5)/10 |
| 4 | 0.35 | (4-0.5)/10 |
| 5 | 0.45 | (5-0.5)/10 |
| 6 | 0.55 | (6-0.5)/10 |
| 7 | 0.65 | (7-0.5)/10 |
| 8 | 0.75 | (8-0.5)/10 |
| 9 | 0.85 | (9-0.5)/10 |
| 10 | 0.95 | (10-0.5)/10 |

### 3.4 Step 3: 이론적 분위수 계산

표준정규분포 N(0,1)에서 각 분위수 위치에 해당하는 **z-값** 계산

$$z_i = \Phi^{-1}(p_i)$$

- $\Phi^{-1}$: 표준정규분포의 역누적분포함수 (Inverse CDF)

| 분위수 위치 (pᵢ) | 이론적 분위수 (zᵢ) | 의미 |
|:---:|:---:|---|
| 0.05 | -1.645 | 하위 5% 지점의 z값 |
| 0.15 | -1.036 | 하위 15% 지점의 z값 |
| 0.25 | -0.674 | 하위 25% 지점의 z값 |
| 0.35 | -0.385 | 하위 35% 지점의 z값 |
| 0.45 | -0.126 | 하위 45% 지점의 z값 |
| 0.55 | +0.126 | 하위 55% 지점의 z값 |
| 0.65 | +0.385 | 하위 65% 지점의 z값 |
| 0.75 | +0.674 | 하위 75% 지점의 z값 |
| 0.85 | +1.036 | 하위 85% 지점의 z값 |
| 0.95 | +1.645 | 하위 95% 지점의 z값 |

### 3.5 Step 4: Q-Q Plot 좌표 생성

| 순위 | 이론적 분위수 (X축) | 표본 분위수 (Y축) |
|:---:|:---:|:---:|
| 1 | -1.645 | 68 |
| 2 | -1.036 | 72 |
| 3 | -0.674 | 74 |
| 4 | -0.385 | 77 |
| 5 | -0.126 | 80 |
| 6 | +0.126 | 83 |
| 7 | +0.385 | 85 |
| 8 | +0.674 | 86 |
| 9 | +1.036 | 89 |
| 10 | +1.645 | 91 |

### 3.6 Step 5: 그래프 시각화

```
    표본 분위수 (Y)
         │
      92 ┤                              ●
      90 ┤                          ●
      88 ┤                      
      86 ┤                    ●
      84 ┤                 ●
      82 ┤              
      80 ┤            ●
      78 ┤          
      76 ┤        ●
      74 ┤      ●
      72 ┤    ●
      70 ┤  
      68 ┤  ●
         └──┬───┬───┬───┬───┬───┬───┬───┬──→ 이론적 분위수 (X)
           -2  -1.5 -1 -0.5  0  0.5  1  1.5  2
           
    → 점들이 거의 직선 위에 있음 = 정규분포를 따름
```

### 3.7 Step 6: 기준선과 비교

**기준선 (Reference Line)** 계산:

만약 데이터가 정규분포 N(μ, σ²)를 따른다면:
$$x_i = \mu + \sigma \cdot z_i$$

표본에서 추정:
- 표본 평균: $\bar{x} = 80.5$
- 표본 표준편차: $s = 7.53$

**기준선 방정식**: $y = 80.5 + 7.53 \cdot x$

| 이론적 분위수 (x) | 기준선 값 | 실제 데이터 | 차이 |
|:---:|:---:|:---:|:---:|
| -1.645 | 68.1 | 68 | -0.1 |
| -1.036 | 72.7 | 72 | -0.7 |
| -0.674 | 75.4 | 74 | -1.4 |
| -0.385 | 77.6 | 77 | -0.6 |
| -0.126 | 79.6 | 80 | +0.4 |
| +0.126 | 81.4 | 83 | +1.6 |
| +0.385 | 83.4 | 85 | +1.6 |
| +0.674 | 85.6 | 86 | +0.4 |
| +1.036 | 88.3 | 89 | +0.7 |
| +1.645 | 92.9 | 91 | -1.9 |

→ 모든 점이 기준선에서 ±2 이내 = **정규성 만족**

---

## 4️⃣ Q-Q Plot 해석 방법

### 4.1 패턴별 해석

```
┌─────────────────────────────────────────────────────────────────┐
│  (A) 정규분포           (B) 오른쪽 꼬리 두꺼움 (Right-skewed)    │
│                                                                 │
│      Y│    ●●●            Y│        ●●                         │
│       │  ●●                │      ●●                            │
│       │●●                  │    ●●                              │
│       └────── X            │  ●●                                │
│                            │●●                                  │
│   → 직선 형태              └────── X                            │
│   → 정규분포 따름           → 위로 휘어짐                        │
│                            → 양의 왜도                          │
├─────────────────────────────────────────────────────────────────┤
│  (C) 왼쪽 꼬리 두꺼움       (D) 양쪽 꼬리 두꺼움 (Heavy-tailed)  │
│      (Left-skewed)                                              │
│                                                                 │
│      Y│●●                  Y│        ●●                         │
│       │  ●●                │    ●●●●                            │
│       │    ●●              │●●                                  │
│       │      ●●            └────── X                            │
│       └────── X                                                 │
│   → 아래로 휘어짐           → S자 형태                           │
│   → 음의 왜도              → 첨도가 높음 (이상치 가능성)          │
├─────────────────────────────────────────────────────────────────┤
│  (E) 양쪽 꼬리 얇음         (F) 이봉분포 (Bimodal)               │
│      (Light-tailed)                                             │
│                                                                 │
│      Y│    ●●              Y│      ●●                           │
│       │●●●●                │  ●●●●                              │
│       │      ●●            │●●    ●●                            │
│       └────── X            └────── X                            │
│   → 역S자 형태              → 계단 형태                          │
│   → 첨도가 낮음            → 두 개의 봉우리                      │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 패턴 요약표

| 패턴 | 그래프 형태 | 의미 | 가능한 원인 |
|---|---|---|---|
| **직선** | 45° 직선 | 정규분포 | - |
| **위로 휘어짐** | 오른쪽 끝이 위로 | 양의 왜도 | 소득, 대기시간 |
| **아래로 휘어짐** | 오른쪽 끝이 아래로 | 음의 왜도 | 시험점수 (쉬운 시험) |
| **S자** | 양 끝이 벗어남 | 두꺼운 꼬리 | 이상치 존재 |
| **역S자** | 중간이 벗어남 | 얇은 꼬리 | 균일분포에 가까움 |
| **계단** | 불연속 | 이산형/이봉분포 | 두 그룹 혼합 |

---

## 5️⃣ Python 구현

### 5.1 기본 Q-Q Plot

```python
import numpy as np
import scipy.stats as stats
import matplotlib.pyplot as plt

# 예제 데이터
data = np.array([72, 85, 91, 68, 77, 83, 89, 74, 80, 86])

# Q-Q Plot 그리기
fig, ax = plt.subplots(figsize=(8, 6))
stats.probplot(data, dist="norm", plot=ax)
ax.set_title('Q-Q Plot: 시험 점수 데이터', fontsize=14)
ax.set_xlabel('이론적 분위수 (Theoretical Quantiles)')
ax.set_ylabel('표본 분위수 (Sample Quantiles)')
ax.grid(True, alpha=0.3)
plt.tight_layout()
plt.show()
```

### 5.2 수동 계산 및 시각화

```python
import numpy as np
import scipy.stats as stats
import matplotlib.pyplot as plt

# 데이터
data = np.array([72, 85, 91, 68, 77, 83, 89, 74, 80, 86])
n = len(data)

# Step 1: 데이터 정렬
sorted_data = np.sort(data)

# Step 2: 분위수 위치 계산
positions = (np.arange(1, n + 1) - 0.5) / n

# Step 3: 이론적 분위수 계산
theoretical_quantiles = stats.norm.ppf(positions)

# Step 4: 결과 출력
print("=" * 60)
print("Q-Q Plot 수동 계산 결과")
print("=" * 60)
print(f"{'순위':^6} {'위치(p)':^10} {'이론적 z':^12} {'표본값':^10}")
print("-" * 60)
for i in range(n):
    print(f"{i+1:^6} {positions[i]:^10.3f} {theoretical_quantiles[i]:^12.3f} {sorted_data[i]:^10}")

# Step 5: 기준선 계산
mean_data = np.mean(data)
std_data = np.std(data, ddof=1)
print(f"\n표본 평균: {mean_data:.2f}")
print(f"표본 표준편차: {std_data:.2f}")
print(f"기준선: y = {mean_data:.2f} + {std_data:.2f} × x")

# Step 6: 시각화
fig, ax = plt.subplots(figsize=(10, 8))

# 산점도
ax.scatter(theoretical_quantiles, sorted_data, s=100, c='blue', 
           edgecolors='black', zorder=5, label='데이터 포인트')

# 기준선
x_line = np.linspace(-2, 2, 100)
y_line = mean_data + std_data * x_line
ax.plot(x_line, y_line, 'r--', linewidth=2, label=f'기준선: y = {mean_data:.1f} + {std_data:.1f}x')

# 각 점에 레이블 추가
for i in range(n):
    ax.annotate(f'{sorted_data[i]}', 
                (theoretical_quantiles[i], sorted_data[i]),
                textcoords="offset points", xytext=(5, 5), fontsize=9)

ax.set_xlabel('이론적 분위수 (z)', fontsize=12)
ax.set_ylabel('표본 분위수 (점수)', fontsize=12)
ax.set_title('Q-Q Plot: 시험 점수의 정규성 검정', fontsize=14)
ax.legend(loc='upper left')
ax.grid(True, alpha=0.3)
ax.set_xlim(-2, 2)
ax.set_ylim(65, 95)

plt.tight_layout()
plt.show()

# Shapiro-Wilk 검정으로 확인
stat, p_value = stats.shapiro(data)
print(f"\n[Shapiro-Wilk 검정]")
print(f"통계량: {stat:.4f}")
print(f"p-value: {p_value:.4f}")
print(f"결론: {'정규성 만족 (p > 0.05)' if p_value > 0.05 else '정규성 불만족 (p < 0.05)'}")
```

### 5.3 실행 결과

```
============================================================
Q-Q Plot 수동 계산 결과
============================================================
 순위     위치(p)      이론적 z       표본값   
------------------------------------------------------------
  1       0.050       -1.645         68    
  2       0.150       -1.036         72    
  3       0.250       -0.674         74    
  4       0.350       -0.385         77    
  5       0.450       -0.126         80    
  6       0.550        0.126         83    
  7       0.650        0.385         85    
  8       0.750        0.674         86    
  9       0.850        1.036         89    
  10      0.950        1.645         91    

표본 평균: 80.50
표본 표준편차: 7.53
기준선: y = 80.50 + 7.53 × x

[Shapiro-Wilk 검정]
통계량: 0.9803
p-value: 0.9710
결론: 정규성 만족 (p > 0.05)
```

---

## 6️⃣ 다양한 분포의 Q-Q Plot 비교

### 6.1 분포별 특성과 Q-Q Plot

```python
import numpy as np
import scipy.stats as stats
import matplotlib.pyplot as plt

np.random.seed(42)
n = 200

# 다양한 분포 생성
distributions = {
    '정규분포': np.random.normal(0, 1, n),
    '오른쪽 왜도 (지수분포)': np.random.exponential(1, n),
    '왼쪽 왜도': -np.random.exponential(1, n),
    '두꺼운 꼬리 (t분포, df=3)': np.random.standard_t(3, n),
    '균일분포': np.random.uniform(-2, 2, n),
    '이봉분포': np.concatenate([np.random.normal(-2, 0.5, n//2), 
                              np.random.normal(2, 0.5, n//2)])
}

fig, axes = plt.subplots(2, 3, figsize=(15, 10))
axes = axes.flatten()

for ax, (name, data) in zip(axes, distributions.items()):
    stats.probplot(data, dist="norm", plot=ax)
    ax.set_title(f'Q-Q Plot: {name}', fontsize=11)
    ax.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()
```

### 6.2 분포별 Q-Q Plot 특징

| 분포 | Q-Q Plot 형태 | 특징 |
|---|---|---|
| **정규분포** | 직선 | 모든 점이 기준선 위 |
| **지수분포** | 위로 휘어짐 | 오른쪽 꼬리가 길다 |
| **음의 왜도** | 아래로 휘어짐 | 왼쪽 꼬리가 길다 |
| **t분포 (df=3)** | S자 | 양쪽 꼬리가 두껍다 |
| **균일분포** | 역S자 | 꼬리가 얇다 |
| **이봉분포** | 계단/꺾임 | 두 개의 봉우리 |

---

## 7️⃣ 핵심 공식 정리

### 7.1 분위수 위치 계산 방법들

| 방법 | 공식 | 사용처 |
|---|---|---|
| **Hazen** | $(i - 0.5) / n$ | 일반적 사용 |
| **Weibull** | $i / (n + 1)$ | Excel PERCENTILE |
| **Blom** | $(i - 3/8) / (n + 1/4)$ | 정규분포에 최적화 |
| **Tukey** | $(i - 1/3) / (n + 1/3)$ | 연속분포에 적합 |

### 7.2 이론적 분위수

$$z_i = \Phi^{-1}(p_i)$$

주요 분위수 값:

| 분위수 (p) | z 값 | 분위수 (p) | z 값 |
|:---:|:---:|:---:|:---:|
| 0.01 | -2.326 | 0.50 | 0.000 |
| 0.025 | -1.960 | 0.75 | 0.674 |
| 0.05 | -1.645 | 0.90 | 1.282 |
| 0.10 | -1.282 | 0.95 | 1.645 |
| 0.25 | -0.674 | 0.975 | 1.960 |

### 7.3 기준선 방정식

$$\hat{x}_i = \bar{x} + s \cdot z_i$$

- $\bar{x}$: 표본 평균
- $s$: 표본 표준편차
- $z_i$: 이론적 분위수

---

## 8️⃣ 정규성 검정 방법 비교

### 8.1 시각적 방법 vs 통계적 검정

| 구분 | 방법 | 장점 | 단점 |
|---|---|---|---|
| **시각적** | Q-Q Plot | 어디서 벗어나는지 확인 | 주관적 |
| | 히스토그램 | 직관적 이해 | 구간 설정에 따라 달라짐 |
| **통계적** | Shapiro-Wilk | 검정력 높음, 소표본 적합 | n > 5000 불가 |
| | Kolmogorov-Smirnov | 대표본 가능 | 검정력 낮음 |
| | Anderson-Darling | 꼬리 부분 민감 | 해석 어려움 |

### 8.2 권장 사용법

```
┌─────────────────────────────────────────────┐
│           정규성 검정 절차                   │
├─────────────────────────────────────────────┤
│                                             │
│  1. Q-Q Plot으로 시각적 확인                 │
│     ↓                                       │
│  2. Shapiro-Wilk 검정 (n ≤ 5000)            │
│     또는 Anderson-Darling (n > 5000)        │
│     ↓                                       │
│  3. 두 결과를 종합하여 판단                  │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 📝 빅데이터분석기사 시험 핵심 포인트

### ✅ 자주 출제되는 개념

1. **Q-Q Plot의 목적**
   - 데이터의 **정규성 검정**을 위한 시각적 도구

2. **축의 의미**
   - X축: 이론적 분위수 (표준정규분포의 z값)
   - Y축: 표본 분위수 (정렬된 데이터)

3. **해석 방법**
   - 직선 → 정규분포 따름
   - 위로 휘어짐 → 양의 왜도 (오른쪽 꼬리)
   - 아래로 휘어짐 → 음의 왜도 (왼쪽 꼬리)
   - S자 → 두꺼운 꼬리 (이상치 가능성)

4. **분위수 위치 공식**
   $$p_i = \frac{i - 0.5}{n}$$

5. **정규성 검정 방법 비교**
   - Q-Q Plot: 시각적, 주관적
   - Shapiro-Wilk: 객관적, 소표본 적합

### ✅ 계산 문제 팁

- 분위수 위치 계산 시 **공식 적용** 주의
- 이론적 분위수는 **표준정규분포표** 활용
- Q-Q Plot 해석 문제에서 **그래프 패턴** 파악

### ✅ 연관 개념

- 왜도 (Skewness): 분포의 비대칭성
- 첨도 (Kurtosis): 꼬리의 두께
- 정규성 검정: Shapiro-Wilk, K-S 검정, A-D 검정

---

*작성일: 2025년*
*빅데이터분석기사 실기 대비 학습자료*
