# 상관관계와 상관관계 유의성 검정

빅데이터분석기사 시험에서 중요한 주제인 상관분석에 대해 정리합니다.

## 1. 상관관계(Correlation)의 개념

**상관관계**는 두 변수 간의 선형적 관계의 강도와 방향을 나타내는 통계적 측도입니다.

### 상관계수의 특징
- **범위**: -1 ≤ r ≤ 1
- **해석**:
  - r = 1: 완벽한 양의 상관관계
  - r = -1: 완벽한 음의 상관관계
  - r = 0: 상관관계 없음
  - |r| > 0.7: 강한 상관관계
  - 0.4 < |r| ≤ 0.7: 중간 상관관계
  - |r| ≤ 0.4: 약한 상관관계

## 2. 상관계수의 종류

### (1) Pearson 상관계수 (피어슨)
**연속형 변수** 간의 **선형 상관관계** 측정

$$r = \frac{\sum_{i=1}^{n}(x_i - \bar{x})(y_i - \bar{y})}{\sqrt{\sum_{i=1}^{n}(x_i - \bar{x})^2}\sqrt{\sum_{i=1}^{n}(y_i - \bar{y})^2}}$$

**가정**:
- 두 변수가 연속형
- 두 변수가 정규분포를 따름
- 선형 관계
- 이상치에 민감

**계산 공식 (간소화)**:

$$r = \frac{n\sum xy - \sum x \sum y}{\sqrt{[n\sum x^2 - (\sum x)^2][n\sum y^2 - (\sum y)^2]}}$$

### (2) Spearman 순위 상관계수 (스피어만)
**순서형 변수** 또는 **비정규분포 데이터**에 사용

$$\rho = 1 - \frac{6\sum d_i^2}{n(n^2-1)}$$

- $d_i$: 각 관측치의 순위 차이
- 비모수적 방법
- 이상치에 강건함

**특징**:
- 데이터를 순위로 변환 후 Pearson 적용
- 단조관계(monotonic relationship) 측정
- 정규성 가정 불필요

### (3) Kendall의 타우(τ)
**순서형 변수**에 사용, Spearman보다 작은 표본에 적합

$$\tau = \frac{(일치쌍의 수 - 불일치쌍의 수)}{전체 쌍의 수}$$

**특징**:
- 모든 가능한 쌍을 비교
- 작은 표본에서 더 정확
- 해석이 직관적

## 3. 상관관계 유의성 검정

### 가설 설정
- **귀무가설(H₀)**: ρ = 0 (두 변수 간 상관관계가 없다)
- **대립가설(H₁)**: ρ ≠ 0 (두 변수 간 상관관계가 있다)

### 검정통계량 (Pearson의 경우)

$$t = r\sqrt{\frac{n-2}{1-r^2}} \sim t_{n-2}$$

- 자유도: n - 2
- p-value < 0.05이면 귀무가설 기각 (유의한 상관관계 존재)

### 검정 절차
1. 상관계수 계산 (r)
2. 검정통계량 계산 (t)
3. p-value 계산
4. 유의수준(α)과 비교하여 결론 도출

## 4. Python 실습 코드

### 기본 상관분석

```python
import numpy as np
import pandas as pd
from scipy import stats
import matplotlib.pyplot as plt
import seaborn as sns

# 1. 샘플 데이터 생성
np.random.seed(42)
n = 100
x = np.random.randn(n)
y = 2 * x + np.random.randn(n) * 0.5  # x와 양의 상관관계

# 2. Pearson 상관계수 계산
pearson_r, pearson_p = stats.pearsonr(x, y)
print(f"Pearson 상관계수: {pearson_r:.4f}")
print(f"p-value: {pearson_p:.4f}")
print(f"유의성: {'유의함' if pearson_p < 0.05 else '유의하지 않음'}\n")

# 3. Spearman 상관계수 계산
spearman_r, spearman_p = stats.spearmanr(x, y)
print(f"Spearman 상관계수: {spearman_r:.4f}")
print(f"p-value: {spearman_p:.4f}\n")

# 4. Kendall 타우 계산
kendall_tau, kendall_p = stats.kendalltau(x, y)
print(f"Kendall의 타우: {kendall_tau:.4f}")
print(f"p-value: {kendall_p:.4f}\n")
```

### DataFrame 상관분석

```python
# 5. DataFrame으로 상관행렬 계산
data = pd.DataFrame({
    'X': x,
    'Y': y,
    'Z': np.random.randn(n)
})

# 상관행렬
corr_matrix = data.corr()
print("상관행렬:")
print(corr_matrix)

# Spearman 상관행렬
spearman_matrix = data.corr(method='spearman')
print("\nSpearman 상관행렬:")
print(spearman_matrix)

# Kendall 상관행렬
kendall_matrix = data.corr(method='kendall')
print("\nKendall 상관행렬:")
print(kendall_matrix)
```

### 시각화

```python
# 6. 시각화
fig, axes = plt.subplots(1, 2, figsize=(12, 5))

# 산점도
axes[0].scatter(x, y, alpha=0.6)
axes[0].plot(np.poly1d(np.polyfit(x, y, 1))(x), color='red')
axes[0].set_xlabel('X')
axes[0].set_ylabel('Y')
axes[0].set_title(f'Scatter Plot (r={pearson_r:.3f}, p={pearson_p:.4f})')
axes[0].grid(True, alpha=0.3)

# 히트맵
sns.heatmap(corr_matrix, annot=True, cmap='coolwarm', center=0,
            square=True, ax=axes[1], vmin=-1, vmax=1)
axes[1].set_title('Correlation Heatmap')

plt.tight_layout()
plt.savefig('correlation_analysis.png', dpi=300, bbox_inches='tight')
plt.show()
```

## 5. 실전 예제 문제

### 문제 1: 기본 상관분석
다음 데이터에서 키(height)와 몸무게(weight)의 Pearson 상관계수를 구하고 유의성을 검정하시오. (유의수준 0.05)

```python
import numpy as np
from scipy import stats

height = [160, 165, 170, 175, 180, 185, 190]
weight = [55, 60, 68, 72, 80, 85, 92]

# 상관계수 계산
r, p_value = stats.pearsonr(height, weight)
print(f"상관계수: {r:.4f}")
print(f"p-value: {p_value:.6f}")

# 검정통계량 직접 계산
n = len(height)
t_stat = r * np.sqrt((n-2) / (1-r**2))
print(f"t-통계량: {t_stat:.4f}")
print(f"자유도: {n-2}")

# 결론
if p_value < 0.05:
    print("결론: 키와 몸무게 사이에 유의한 양의 상관관계가 있다.")
else:
    print("결론: 키와 몸무게 사이에 유의한 상관관계가 없다.")
```

**출력 결과**:
```
상관계수: 0.9964
p-value: 0.000013
t-통계량: 26.7436
자유도: 5
결론: 키와 몸무게 사이에 유의한 양의 상관관계가 있다.
```

### 문제 2: 비정규 데이터
정규분포를 따르지 않는 데이터의 경우 적절한 상관계수는?

```python
# 정규분포를 따르지 않는 데이터 생성
np.random.seed(42)
x = np.random.exponential(2, 100)
y = x + np.random.exponential(1, 100)

# Pearson vs Spearman 비교
pearson_r, pearson_p = stats.pearsonr(x, y)
spearman_r, spearman_p = stats.spearmanr(x, y)

print(f"Pearson 상관계수: {pearson_r:.4f} (p={pearson_p:.4f})")
print(f"Spearman 상관계수: {spearman_r:.4f} (p={spearman_p:.4f})")
print("\n권장: 비정규분포 데이터는 Spearman 사용!")
```

### 문제 3: 순위 상관계수
다음 두 학생의 과목별 순위로 Spearman 상관계수를 계산하시오.

```python
# 학생 A와 B의 과목별 순위
subject = ['수학', '영어', '과학', '국어', '사회']
rank_A = [1, 3, 2, 4, 5]
rank_B = [2, 3, 1, 5, 4]

# Spearman 상관계수
rho, p_value = stats.spearmanr(rank_A, rank_B)
print(f"Spearman 상관계수: {rho:.4f}")
print(f"p-value: {p_value:.4f}")

# 수동 계산
d = np.array(rank_A) - np.array(rank_B)
n = len(rank_A)
rho_manual = 1 - (6 * sum(d**2)) / (n * (n**2 - 1))
print(f"수동 계산 결과: {rho_manual:.4f}")
```

## 6. 주의사항 및 해석

### 상관관계 ≠ 인과관계
- 상관관계가 있다고 해서 인과관계가 있는 것은 아님
- 제3의 변수(교란변수)가 존재할 수 있음
- 예: 아이스크림 판매량과 익사 사고는 양의 상관관계가 있지만, 실제 원인은 '여름'이라는 교란변수

### Pearson 상관계수의 한계
1. **비선형 관계 포착 불가**
   - U자형, 역U자형 관계는 r ≈ 0으로 나타남
   - 산점도를 반드시 확인해야 함

2. **이상치에 민감**
   - 극단값 하나가 상관계수를 크게 왜곡
   - 이상치 제거 또는 Spearman 사용 고려

3. **정규성 가정 필요**
   - 유의성 검정을 위해 이변량 정규분포 가정
   - Shapiro-Wilk 검정으로 정규성 확인

### 다중공선성(Multicollinearity)
독립변수 간 높은 상관관계가 있을 때 발생

**진단 기준**:
- 상관계수 |r| > 0.8: 다중공선성 의심
- VIF > 10: 심각한 다중공선성
- VIF > 5: 다중공선성 주의

```python
from statsmodels.stats.outliers_influence import variance_inflation_factor

# VIF 계산 예제
X = pd.DataFrame({
    'X1': np.random.randn(100),
    'X2': np.random.randn(100),
    'X3': np.random.randn(100)
})

# X2를 X1과 강한 상관관계를 갖도록 수정
X['X2'] = X['X1'] + np.random.randn(100) * 0.1

# VIF 계산
vif_data = pd.DataFrame()
vif_data["변수"] = X.columns
vif_data["VIF"] = [variance_inflation_factor(X.values, i) 
                    for i in range(len(X.columns))]
print(vif_data)
print("\nVIF > 10: 심각한 다중공선성")
print("VIF > 5: 다중공선성 의심")
```

**해결 방법**:
- 상관관계가 높은 변수 중 하나 제거
- PCA(주성분 분석)로 차원 축소
- Ridge, Lasso 회귀 사용

## 7. 편상관계수 (Partial Correlation)

제3의 변수의 영향을 제거한 후 두 변수 간의 순수한 상관관계

```python
from scipy.stats import pearsonr

def partial_correlation(data, x, y, z):
    """
    z의 영향을 제거한 x와 y의 편상관계수
    """
    # x와 y의 상관계수
    r_xy = data[[x, y]].corr().iloc[0, 1]
    
    # x와 z의 상관계수
    r_xz = data[[x, z]].corr().iloc[0, 1]
    
    # y와 z의 상관계수
    r_yz = data[[y, z]].corr().iloc[0, 1]
    
    # 편상관계수 공식
    r_xy_z = (r_xy - r_xz * r_yz) / (np.sqrt(1 - r_xz**2) * np.sqrt(1 - r_yz**2))
    
    return r_xy_z

# 예제
data = pd.DataFrame({
    'X': np.random.randn(100),
    'Y': np.random.randn(100),
    'Z': np.random.randn(100)
})

partial_r = partial_correlation(data, 'X', 'Y', 'Z')
print(f"편상관계수: {partial_r:.4f}")
```

## 8. 상관분석 체크리스트

### 분석 전 확인사항
- [ ] 변수의 척도 확인 (연속형/순서형)
- [ ] 정규성 검정 (Shapiro-Wilk)
- [ ] 이상치 확인 (박스플롯, z-score)
- [ ] 산점도로 관계의 형태 확인

### 적절한 상관계수 선택
| 조건 | 사용할 상관계수 |
|------|----------------|
| 연속형 + 정규분포 + 선형관계 | Pearson |
| 순서형 또는 비정규분포 | Spearman |
| 작은 표본 + 순서형 | Kendall |
| 비선형 단조관계 | Spearman |

### 결과 해석
- [ ] 상관계수의 크기와 방향 확인
- [ ] p-value로 유의성 판단
- [ ] 산점도로 시각적 확인
- [ ] 상관관계 ≠ 인과관계 주의

## 9. 시험 출제 포인트

### 자주 나오는 유형

1. **상관계수 계산**
   - 수식을 이용한 직접 계산
   - Python 코드 작성 및 해석

2. **유의성 검정**
   - t-통계량 계산
   - p-value 해석 및 결론 도출

3. **적절한 방법 선택**
   - 데이터 특성에 따른 상관계수 선택
   - Pearson vs Spearman 비교

4. **상관행렬 해석**
   - 히트맵 분석
   - 다중공선성 진단

5. **실전 문제**
   - 주어진 데이터로 상관분석 수행
   - 결과 해석 및 결론 작성

### 핵심 개념 정리

| 개념 | 설명 |
|------|------|
| 상관계수 범위 | -1 ≤ r ≤ 1 |
| 강한 상관관계 | \|r\| > 0.7 |
| 유의수준 | 일반적으로 α = 0.05 |
| 자유도 | n - 2 (Pearson) |
| 다중공선성 | \|r\| > 0.8 또는 VIF > 10 |

### 실수하기 쉬운 포인트
1. 상관관계를 인과관계로 해석
2. 비선형 관계를 Pearson으로 분석
3. 이상치 영향 무시
4. 정규성 가정 확인 생략
5. 산점도 확인 없이 수치만 해석

## 10. 추가 연습 문제

### 연습 1
다음 데이터의 상관관계를 분석하고 적절한 상관계수를 선택하시오.

```python
# 데이터
study_hours = [2, 3, 5, 6, 8, 10, 12]
test_scores = [60, 65, 75, 80, 85, 90, 95]

# 1. 정규성 검정
from scipy.stats import shapiro
stat1, p1 = shapiro(study_hours)
stat2, p2 = shapiro(test_scores)
print(f"공부시간 정규성: p={p1:.4f}")
print(f"시험점수 정규성: p={p2:.4f}")

# 2. 산점도
plt.scatter(study_hours, test_scores)
plt.xlabel('Study Hours')
plt.ylabel('Test Scores')
plt.title('Relationship between Study Hours and Test Scores')
plt.grid(True, alpha=0.3)
plt.show()

# 3. 상관분석
r, p = stats.pearsonr(study_hours, test_scores)
print(f"\nPearson r: {r:.4f}, p-value: {p:.4f}")
```

### 연습 2
다음 상황에서 올바른 분석 방법을 선택하시오.

**상황 A**: 학생 50명의 키와 몸무게 데이터 (정규분포)  
**상황 B**: 제품 만족도 순위 (1~5점)와 재구매 의향 순위 (1~5점)  
**상황 C**: 소득과 행복도 (소득은 오른쪽 꼬리가 긴 분포)

**답안**:
- 상황 A: Pearson (연속형 + 정규분포)
- 상황 B: Spearman 또는 Kendall (순서형)
- 상황 C: Spearman (비정규분포)

## 11. 참고 자료

### 중요 공식 요약

1. **Pearson 상관계수**:
   $$r = \frac{\sum(x_i - \bar{x})(y_i - \bar{y})}{\sqrt{\sum(x_i - \bar{x})^2}\sqrt{\sum(y_i - \bar{y})^2}}$$

2. **검정통계량**:
   $$t = r\sqrt{\frac{n-2}{1-r^2}}$$

3. **Spearman 상관계수**:
   $$\rho = 1 - \frac{6\sum d_i^2}{n(n^2-1)}$$

4. **편상관계수**:
   $$r_{xy\cdot z} = \frac{r_{xy} - r_{xz}r_{yz}}{\sqrt{1-r_{xz}^2}\sqrt{1-r_{yz}^2}}$$

### Python 주요 함수

```python
# scipy.stats
stats.pearsonr(x, y)          # Pearson 상관계수
stats.spearmanr(x, y)         # Spearman 상관계수
stats.kendalltau(x, y)        # Kendall 타우

# pandas
df.corr()                      # 상관행렬 (기본: Pearson)
df.corr(method='spearman')     # Spearman 상관행렬
df.corr(method='kendall')      # Kendall 상관행렬

# seaborn
sns.heatmap(corr_matrix, annot=True)  # 상관행렬 히트맵
sns.pairplot(df)                       # 모든 변수 쌍의 산점도
```

---

**작성일**: 2026-01-27  
**목적**: 빅데이터분석기사 시험 대비  
**주제**: 상관관계 및 상관관계 유의성 검정
